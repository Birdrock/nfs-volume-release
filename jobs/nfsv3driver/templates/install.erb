#!/bin/bash
<% if p("nfsv3driver.disable") %>
<% else %>
set -e

wait_for_dpkg_lock() {
for x in `seq 1 100`; do
    if ! [[ `lsof /var/lib/dpkg/lock` ]]
    then
        return 0
    fi
    sleep 3
done
return 1
}

install_if_missing ()
{
    set +e
    dpkg -s $1
    not_installed=$(echo $?)
    if [ not_installed ]; then
    while :
    do
      dpkg  --force-confdef -i $2
      if [ $? -ne 0 ] ; then
        wait_for_dpkg_lock || exit 1
      else
       break
      fi
    done
    fi
    set -e
}

function copy_client_certs_to_spec_dir() {
  local cert_dir="<%= p('nfsv3driver.driver_path') %>/certs/nfsv3driver"

  mkdir -p ${cert_dir}
  cp -p /var/vcap/jobs/nfsv3driver/config/certs/ca.crt ${cert_dir}
  cp -p /var/vcap/jobs/nfsv3driver/config/certs/client.crt ${cert_dir}
  cp -p /var/vcap/jobs/nfsv3driver/config/certs/client.key ${cert_dir}
}

codename=$(lsb_release -c | grep xenial | awk '{print $2}')
if [ "$codename" == "xenial" ]; then
    echo "Installing NFS packages"
    (
    flock -x 200
    install_if_missing rpcbind /var/vcap/packages/nfs-debs/rpcbind_0.2.3-0.2_amd64.deb
    install_if_missing keyutils /var/vcap/packages/nfs-debs/keyutils_1.5.9-8ubuntu1_amd64.deb
    install_if_missing libevent-2.0-5 /var/vcap/packages/nfs-debs/libevent-2.0-5_2.0.21-stable-2ubuntu0.16.04.1_amd64.deb
    install_if_missing libnfsidmap2 /var/vcap/packages/nfs-debs/libnfsidmap2_0.25-5_amd64.deb
    install_if_missing nfs-common /var/vcap/packages/nfs-debs/nfs-common_1%3a1.2.8-9ubuntu12.1_amd64.deb
    ) 200>/var/vcap/data/dpkg.lock
fi

echo "Copying client certs to data directory..."
copy_client_certs_to_spec_dir

exit 0
<% end %>